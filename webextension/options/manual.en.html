<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>withExEditor Manual</title>
    <link rel="stylesheet" href="../css/options.css" />
  </head>
  <body>
    <header>
      <h1>Manual</h1>
    </header>
    <main>
      <section>
        <h1>Important Notice</h1>
        <p>
          Unlike the Jetpack SDK used by prior withExEditor, Mozilla's new add-on ecosystem WebExtensions does not allow to spawn child process from the add-on (that is, external editor can not be executed directly anymore).
          Instead, in WebExtensions, the browser interacts with native application via messages.
          For details, refer to <a href="https://developer.mozilla.org/en-US/Add-ons/WebExtensions/Native_messaging">Native messaging - Mozilla | MDN</a>.
        </p>
        <p>
          Therefore, to use withExEditor, you need to prepare:
        </p>
        <ul>
          <li>
            A host which executes the external editor
          </li>
          <li>
            An application manifest of the host
          </li>
        </ul>
      </section>
      <section>
        <h1>Host</h1>
        <p>
          Create a host which executes the editor, and save it in an arbitrary location.
          The host should be able to handle binary data passed in standard input (stdin).
          From withExEditor, "temporary file path", which is created for source view / text edit, will be sent to the host.
        </p>
        <p>
          The following is an example of a host using a python script.
        </p>
        <figure>
          <figcaption>Python Script Example (Windows / Linux / Mac):</figcaption>
          <pre><code>#!/usr/bin/env python
# coding: utf-8

import sys, json, struct, subprocess

# Read a message from stdin and decode it.
def getMessage():
  rawLength = sys.stdin.buffer.read(4)
  if len(rawLength) == 0:
    sys.exit(0)
  message = sys.stdin.buffer.read(struct.unpack('@I', rawLength)[0])
  if message:
    return json.loads(message.decode('utf-8'))
  else:
    return false

# Editor path
app = "C:\Program Files\Path\To\YourEditor.exe"

# Command line arguments array as appropriate.
# args = []

while True:
  file = getMessage()
  cmd = []
  cmd.append(app)
  
  # If you have arguments and want arguments before file
  # cmd.extend(args)

  cmd.append(file)

  # If you have arguments and want arguments after file
  # cmd.extend(args)

  subprocess.run(cmd)

sys.exit()
</code></pre>
        </figure>
        <p>
          On Windows, also create a shell script (batch file) to execute python script.
        </p>
        <figure>
          <figcaption>Shell Script Example (Windows):</figcaption>
          <pre><code>@echo off
python "C:\path\to\youreditor.py"</code></pre>
        </figure>
      </section>
      <section>
        <h1>Application manifest</h1>
        <p>
          Create an application manifest in JSON format that contains the path of the host.
        </p>
        <figure>
          <figcaption>Manifest Example:</figcaption>
          <pre><code>{
  "name": "youreditor",
  "description": "Host to execute youreditor"
  "path": "C:\\path\\to\\youreditor.cmd",
  "type": "stdio",
  "allowed_extensions": ["jid1-WiAigu4HIo0Tag@jetpack"]
}</code></pre>
        </figure>
        <dl>
          <dt>name</dt>
          <dd>
            The name of the editor to use.
            Only lowercase letters and numbers, dots, underscores are allowed.
            It must also match the filename of the host.
          </dd>
          <dt>description</dt>
          <dd>Description of the host.</dd>
          <dt>path</dt>
          <dd>
            The path of the host that executes the editor.
            Note that on Windows, it is necessary to escape backslashes, which is a directory delimiter, by adding an extra backslash.
            Also on Windows, if you created a host with the python script following the above example, fill in the path of the shell script, not the path of the python script.
          </dd>
          <dt>type</dt>
          <dd>Enter "stdio".</dd>
          <dt>allowed_extensions</dt>
          <dd>
            An array of addon IDs.
            Fill in the bracket with "jid1-WiAigu4HIo0Tag@jetpack" which is ID of withExEditor.
          </dd>
        </dl>
        <p>
          Save the manifest with the same file name as the "name" field, the file extension of.json, and the character code of UTF-8 (without BOM).
          Refer to <a href="https://developer.mozilla.org/en-US/Add-ons/WebExtensions/Native_messaging#App_manifest_location">App manifest location</a> where to save the manifest.
        </p>
        <p>
          On Windows, you also need to set the registry.
          If the path of the manifest is "C:\Users\xxx\youreditor.json", run the following command with cmd.exe.
          Then you can save the registry key.
        </p>
        <figure>
          <figcaption>REG ADD Example (Windows):</figcaption>
          <pre><code>REG ADD "HKEY_CURRENT_USER\SOFTWARE\Mozilla\NativeMessagingHosts\youreditor" /ve /d "C:\Users\xxx\youreditor.json" /f</code></pre>
        </figure>
      </section>
      <p>
        After completing the above work, <em>enter the manifest path in <a href="./options.html">Options page</a></em>.
      </p>
    </main>
  </body>
</html>
