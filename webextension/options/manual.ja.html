<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>withExEditor マニュアル</title>
    <link rel="stylesheet" href="../css/options.css" />
    <script src="../js/manual.js"></script>
  </head>
  <body>
    <header>
      <h1>マニュアル</h1>
    </header>
    <main>
      <section>
        <h1>重要なお知らせ</h1>
        <p>
          これまでのwithExEditorで使用してきたJetpack SDKとは異なり、Mozillaの新しいアドオンのエコシステムWebExtensionsでは、アドオンから子プロセスを生成することはできません（つまり、外部エディタはもう直接起動できません）。
          代わりに、WebExtensionsでは、ブラウザはメッセージを介してネイティブアプリケーションとやりとりする仕組みとなっています。
          詳細については、<a href="https://developer.mozilla.org/ja/Add-ons/WebExtensions/Native_messaging">Native messaging - Mozilla | MDN</a>を参照してください。
        </p>
        <p>
          このため、withExEditorを使うにあたり、ユーザーのみなさんは：
        </p>
        <ul>
          <li>
            外部エディタを起動するためのホスト
          </li>
          <li>
            ホストのアプリケーションマニフェスト
          </li>
        </ul>
        <p>
          を準備する必要があります。
        </p>
      </section>
      <section>
        <h1>ホスト</h1>
        <p>
          使用するエディタを起動するホストを作成し、任意の場所に保存します。
          ホストは標準入力（stdin）で渡されるバイナリデータを扱えるものである必要があります。
          withExEditorからはソース表示やテキスト編集用に作成した「一時ファイルのパス」をホストに送信します。
        </p>
        <p>
          以下はPythonで書いたホストの例です。
        </p>
        <figure>
          <figcaption>Pythonスクリプトによるホストの例：</figcaption>
          <pre><code>#!/usr/bin/env python
# coding: utf-8

import sys, json, struct, subprocess

# Read a message from stdin and decode it.
def getMessage():
  rawLength = sys.stdin.buffer.read(4)
  if len(rawLength) == 0:
    sys.exit(0)
  message = sys.stdin.buffer.read(struct.unpack('@I', rawLength)[0])
  if message:
    return json.loads(message.decode('utf-8'))
  else:
    return false

# Editor path
app = "C:\Program Files\Path\To\YourEditor.exe"

# Command line arguments array as appropriate.
# args = []

while True:
  file = getMessage()
  cmd = []
  cmd.append(app)

  # If you have arguments and want arguments before file
  # cmd.extend(args)

  cmd.append(file)

  # If you have arguments and want arguments after file
  # cmd.extend(args)

  subprocess.run(cmd)

sys.exit(0)</code></pre>
        </figure>
        <p>
          Windowsでは、pythonスクリプトを実行するためのシェルスクリプト（バッチファイル）も作成します。
        </p>
        <figure>
          <figcaption>シェルスクリプトの例（Windows）：</figcaption>
          <pre><code>@echo off
python "C:\path\to\youreditor.py"</code></pre>
        </figure>
      </section>
      <section>
        <h1>アプリケーションマニフェスト</h1>
        <p>
          ホストのパスを含むJSON形式のアプリケーションマニフェストを作成します。
        </p>
        <figure>
          <figcaption>マニフェストの例：</figcaption>
          <pre><code>{
  "name": "youreditor",
  "description": "Host to execute youreditor",
  "path": "C:\\path\\to\\youreditor.cmd",
  "type": "stdio",
  "allowed_extensions": ["jid1-WiAigu4HIo0Tag@jetpack"]
}</code></pre>
        </figure>
        <dl>
          <dt>name</dt>
          <dd>
            使用するエディタの名前。
            小文字の英字と数字、ドット、アンダーバーのみ使用可能です。
            また、ホストのファイル名と一致している必要があります。
          </dd>
          <dt>description</dt>
          <dd>ホストの説明。</dd>
          <dt>path</dt>
          <dd>
            エディタを起動するホストのパス。
            Windowsの場合は、ディレクトリの区切りであるバックスラッシュ文字にはさらにバックスラッシュを加えてエスケープさせる必要があることに注意してください。
            また、上記の例に倣ってpythonスクリプトでホストを作成した場合、Windowsではpythonスクリプトのパスではなく、シェルスクリプトのパスを記入してください。</dd>
          <dt>type</dt>
          <dd>"stdio"を記入してください。</dd>
          <dt>allowed_extensions</dt>
          <dd>
            アドオンのIDの配列。
            withExEditorのIDである"jid1-WiAigu4HIo0Tag@jetpack"を[]括弧の中に記入してください。
          </dd>
        </dl>
        <p>
          マニフェストは、 "name"フィールドと同じファイル名、.jsonのファイル拡張子、UTF-8（BOMなし）の文字コードで保存してください。
          保存先については、<a href="https://developer.mozilla.org/ja/Add-ons/WebExtensions/Native_messaging#App_manifest_location">App manifest location</a>を参照してください。
        </p>
        <p>
          Windowsではさらにレジストリも設定する必要があります。
          マニフェストを"C:¥Users¥xxx¥youreditor.json"に保存したと仮定した場合、cmd.exeで次のコマンドを実行するとレジストリキーを保存することができます。
        </p>
        <figure>
          <figcaption>REG ADDの例（Windows）：</figcaption>
          <pre><code>REG ADD "HKEY_CURRENT_USER\SOFTWARE\Mozilla\NativeMessagingHosts\youreditor" /ve /d "C:\Users\xxx\youreditor.json" /f</code></pre>
        </figure>
      </section>
      <p>
        以上の作業を終えたら、<em><a href="./options.html">設定ページ</a>でマニフェストのパスを入力してください</em>。
      </p>
    </main>
  </body>
</html>
